---
title: "Introduction to wowi"
author: "Tom√°s Zaba"
output: rmarkdown::html_vignette
bibliography: references.bib
cls: harvard-cite-them-right-11th-edition.csl
vignette: >
  %\VignetteIndexEntry{Introduction to wowi}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(wowi)
```

## Overview 

Acute malnutrition remains a critical public health concern, particularly in fragile and humanitarian settings, often requiring targetted interventions. Its spatial distribution is often uneven, with clusters of elevated burden. Understanding where these unusual high-burden areas exist is crucial for effective planning, resource allocation, early warning systems, and timely response to alleviate the plight of the affected population.  

In this article, you will learn how to use the `wowi` R package to understand the spatial distribution of acute malnutrition in your data set. Before we start with the walk through, it is important to have some critical concepts under your belt. 

### The Spatial Scan Approach  

To identify statistically significant spatial clusters, analysts frequently rely on [`SaTScan`](https://www.satscan.org), a powerful tool for spatial and spatio-temporal scan statistics. SaTScan's __Bernoulli model__ is particularly suited for binary outcomes such as: 

+ "Case" = child is acutely malnourished
+ "Control" = child is not acutely malnourished

It evaluates whether observed clustering of cases exceeds what would be expected by chance @satscan.

### Scanning for high-burden acute malnutrition clusters using `wowi` 

The `wowi` R package provides a tidy, reproducible interface for running Bernoulli spatial scan analysis via SaTScan. It depends on the [`rsatscan`](https://cran.r-project.org/web/packages/rsatscan/index.html) R package, which enables the use of `SaTScan` software from within R. While `rsatscan` offers general-purpose functionality, `wowi` was specifically developed for acute malnutrition analysis, tailoring the tools to the needs of nutrition-focused spatial investigations. 

### What outputs does `wowi` provide?

The package returns the standard set of outputs generated by SaTScan: 

1. An interactive HTML map displaying the detected clusters. These can be opened with any web browser, and user can play it with it - zoom in and out, click on the bubbles and see the statistics about the bubbles, and more.
2. A text-based output with extension `.txt` containing the results.
3. Additional GIS-based files (e.g., shapefiles), which can be useful for further geospatial manipulation or integration into other mapping workflows.
4. Furthermore, it also returns a tidy data frame summarising the detected clusters, parsed from the text-based file described in point 2. This summary enables easier manipulation and integration into an analyst‚Äôs downstream workflow.

> __Tip__ üí°
>
> The output described in point 4 offers an IPC Acute Malnutrition-related insight for IPC users. It indicates whether the number of survey clusters or enumeration area IDs included in the detected cluster‚Äîand the total number of children‚Äîmeet the IPC Acute Malnutrition criteria for disaggregated analysis, as recommended when the design effect exceeds 1.3 [@ipcmanual]  
>
> The results are presented in the final column of the table and take one of two possible values:  
>
> + ‚Äúyes‚Äù ‚Äì the number of cluster IDs is ‚â• 5 and the number of children with valid measurements is ‚â• 100.  
>
> + ‚Äúno‚Äù ‚Äì the criteria above are not met.

## Using `wowi` to identify spatial clusters  

The analysis workflow with wowi begins with the standard anthropometric data processing steps: data wrangling and quality checks. For this purpose, wowi relies on the [`mwana`](https://nutriverse.io/mwana/dev/) package, which will be installed or updated automatically when you install wowi. 

Further downstream in the analysis, the sf package is required to generate shapefile-related outputs. Note that [`sf`](https://r-spatial.github.io/sf/) is not installed with wowi, so you must install it separately.

> __Note ‚ìò__
>
> `wowi` will not function unless the SaTScan software is installed on your machine. You can download it from: <https://www.satscan.org>. 
>
> Once installed, copy the path to the SaTScan executable on your machine. This is needed for R to locate and run it. 

We will now begin the demonstration using the package‚Äôs built-in dataset, `anthro`.

```{r sample-data, echo = TRUE}
head(anthro)
```

This is a SMART survey dataset, which includes geographical coordinates: the `x` and `y` columns, along with the corresponding precision recorded in the `precision` column.

> __Note ‚ìò__
>
> __Geographical coordinates are indispensable for spatial cluster detection__ ‚Äî without precise location data, spatial analysis simply cannot be performed.
> 

### Data wrangling 

You can scan for spatial clusters using acute malnutrition case definitions based on weight-for-height z-scores and/or oedema, mid-upper arm circumference (MUAC) and/or oedema, or a combined definition. The data wrangling workflow should be configured accordingly. In this article, we will demonstrate using the former.

```{r wrangle-data-with-mwana, echo = TRUE}
library(mwana)

a <- anthro |>
  mw_wrangle_wfhz(
    sex = sex,
    weight = weight,
    height = height,
    .recode_sex = FALSE
  ) |>
  define_wasting(
    zscores = wfhz,
    edema = oedema,
    .by = "zscores"
  ) |>
  dplyr::rename(
    longitude = x,
    latitude = y
  )
```

Hereafter, you can check the quality of the data. Learn how to do so [here](https://nutriverse.io/mwana/dev/articles/plausibility.html).

### Run the Bernoulli model spatial scan 

This is handled by the `ww_run_satscan()` function. Read its full documentation by typing `?ww_run_satscan` in your console or by clicking [here](https://nutspatial.github.io/wowi/reference/ww_run_satscan.html).  

You can run the analysis on either a single-area dataset or a multiple-area dataset. We will begin with the former, followed by the latter 

#### Single-area data set
```{r, single-area-set-up, echo = FALSE}                                           
## Set up a temporary directory just for this demo ----
directory <- file.path(withr::local_tempdir(), "input-files")
```

```{r single-area-subset-df, echo = TRUE}
## Filter out one district from the data set -----
d <- subset(a, district == "Kotido")
```

```{r single-area-run-satscan, echo = TRUE, message = FALSE}
## Load rsatscan ----
suppressPackageStartupMessages(library(rsatscan)) #<1>

## Set up the paramters ----
results <- ww_run_satscan(
  .data = d,
  filename = "Kotido",
  dir = directory, #<2>
  sslocation = "/Applications/SaTScan.app/Contents/app", #<3>
  ssbatchfilename = "satscan", #<4>
  satscan_version = "10.3.2",
  .by_area = FALSE,
  .scan_for = "high-low-rates",
  .gam_based = "wfhz",
  area = NULL,
  cleanup = TRUE,
  verbose = FALSE
)
```

1. Although you will never use the `rsatscan` package explicitly, you must make it available in your environment. This is because it creates a specific environment object, `ssenv`, required for `wowi` to function. If this is not loaded, `wowi` will not run. 

2. Specify the folder where you would like the output results to be saved for your analysis.

3. Provide the path to your SaTScan GUI installation. This varies depending on your operating system (OS). For macOS, it is typically "/Applications/SaTScan.app/Contents/app"; for Windows, "C:/Program Files/SaTScan".

4. Indicate the name of the SaTScan batch file. For macOS, use "satscan"; for Windows, use "SaTScanBatch64". 

#### Getting acquainted with the files
The code above will generate seven files in the folder you specified using the `dir` argument. These files will share a common base name, as defined by the string provided in the `filename` argument.

```{r single-area-show-files, echo = FALSE}
list.files(file.path(directory))
```

+ The `.cas`, `.ctl` and `.geo` files are SaTScan input datasets representing cases, controls and geographical coordinates, respectively. 
+ The `.clustermap.html` file is an interactive HTML visualisation with an embedded Google Map displaying the detected clusters.
+ All other files are related to shapefiles and can be used for further GIS analysis and manipulation. 

Furthermore, we can view the results in a text-based format. To do this, we access the object to which we assigned the results of `ww_run_satscan()`. In our demo, this object is called results.

To see the text-based results, we use `results$.txt`. As this file is quite long, for the purposes of this demo we will only display the first 48 rows.

```{r single-area-show-txt}
head(results$.txt, 48)
```

This file isn‚Äôt very convenient if we want to perform further manipulation. Don‚Äôt worry ‚Äî `ww_run_satscan()` has got you covered ‚òÇÔ∏è. It parses the text-based results into a tidy data frame that you can easily work with üòé. To access it, simply subset the results object like this: `results$.df`: 

```{r single-area-show-df}
results$.df
```

#### Multiple-area data set 

We use a dataset containing multiple areas. In our example dataset, there are several districts, so we want to run the spatial scan on a district-wise basis. To do this, we set the filename parameter to NULL, then set `.by_area = TRUE`, and finally specify the column in our dataset that stores the areas‚Äîin this case, district.

For this demo, we will filter out just two districts. 

```{r multiple-area-subset-df, echo = TRUE}
## Filter out two districts -----
ds <- subset(a, district == "Kotido" | district == "Abim")
```

```{r multiple-area-run-satscan, echo = TRUE, message = FALSE}
## Set up the paramters ----
multiple_area <- ww_run_satscan(
  .data = ds,
  filename = NULL,
  dir = directory, #<2>
  sslocation = "/Applications/SaTScan.app/Contents/app", #<3>
  ssbatchfilename = "satscan", #<4>
  satscan_version = "10.3.2",
  .by_area = TRUE,
  .scan_for = "high-low-rates",
  .gam_based = "wfhz",
  area = district,
  cleanup = TRUE,
  verbose = FALSE
)
```

This returns the following outputs:

```{r multiple-area-show-files, echo = FALSE}
list.files(file.path(directory))
```

We can also obtain the tidy data frame:

```{r multiple-area-show-df}
multiple_area$.df
```
